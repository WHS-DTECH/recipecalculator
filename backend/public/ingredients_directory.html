                        // DEBUG: Show API response above navbar
                        const debugDiv = document.createElement('div');
                        debugDiv.style.background = '#fffbe6';
                        debugDiv.style.color = '#b36b00';
                        debugDiv.style.padding = '0.5rem';
                        debugDiv.style.margin = '1rem 0';
                        debugDiv.style.fontSize = '1rem';
                        debugDiv.innerText = '[DEBUG] /api/ingredients/inventory/all response: ' + JSON.stringify(data);
                        document.body.insertBefore(debugDiv, document.body.firstChild);
                        // DEBUG: Show if table container exists
                        const containerDebug = document.createElement('div');
                        containerDebug.style.background = '#e6f7ff';
                        containerDebug.style.color = '#0050b3';
                        containerDebug.style.padding = '0.5rem';
                        containerDebug.style.margin = '1rem 0';
                        containerDebug.style.fontSize = '1rem';
                        if (container) {
                          containerDebug.innerText = '[DEBUG] ingredients-inventory-table element found.';
                        } else {
                          containerDebug.innerText = '[DEBUG] ERROR: ingredients-inventory-table element NOT found!';
                        }
                        document.body.insertBefore(containerDebug, document.body.firstChild);
                        // DEBUG: Show if renderIngredientsInventoryTable is defined
                        const funcDebug = document.createElement('div');
                        funcDebug.style.background = '#fff0f6';
                        funcDebug.style.color = '#c41d7f';
                        funcDebug.style.padding = '0.5rem';
                        funcDebug.style.margin = '1rem 0';
                        funcDebug.style.fontSize = '1rem';
                        if (typeof window.renderIngredientsInventoryTable === 'function') {
                          funcDebug.innerText = '[DEBUG] renderIngredientsInventoryTable function is defined.';
                        } else {
                          funcDebug.innerText = '[DEBUG] ERROR: renderIngredientsInventoryTable function is NOT defined!';
                        }
                        document.body.insertBefore(funcDebug, document.body.firstChild);
                          // DEBUG: Show when function is called
                          const callDebug = document.createElement('div');
                          callDebug.style.background = '#f6ffed';
                          callDebug.style.color = '#389e0d';
                          callDebug.style.padding = '0.5rem';
                          callDebug.style.margin = '1rem 0';
                          callDebug.style.fontSize = '1rem';
                          callDebug.innerText = '[DEBUG] renderIngredientsInventoryTable CALLED.';
                          document.body.insertBefore(callDebug, document.body.firstChild);
                        // DEBUG: Show error loading inventory data
                        const debugDiv = document.createElement('div');
                        debugDiv.style.background = '#fffbe6';
                        debugDiv.style.color = '#b36b00';
                        debugDiv.style.padding = '0.5rem';
                        debugDiv.style.margin = '1rem 0';
                        debugDiv.style.fontSize = '1rem';
                        debugDiv.innerText = '[DEBUG] Error loading inventory data: ' + (err && err.message ? err.message : err);
                        document.body.insertBefore(debugDiv, document.body.firstChild);
      // Ensure our inventory table render function is always used
        window.renderIngredientsTable = window.renderIngredientsInventoryTable;
        <script>
          // Helper: set Recipe ID filter and trigger filter
      function setRecipeIdAndFilter(recipeId) {
        const filterInput = document.getElementById('filter-recipe-id');
        console.log('[setRecipeIdAndFilter] Called with recipeId:', recipeId);
        if (filterInput) {
          filterInput.value = recipeId;
          console.log('[setRecipeIdAndFilter] Set filter input value to:', filterInput.value);
          if (typeof filterAndShowByRecipeId === 'function') {
            console.log('[setRecipeIdAndFilter] Calling filterAndShowByRecipeId');
            filterAndShowByRecipeId();
          } else {
            console.warn('[setRecipeIdAndFilter] filterAndShowByRecipeId is not a function');
          }
        } else {
          console.warn('[setRecipeIdAndFilter] filter-recipe-id input not found');
        }
      }
          // Load Extracted Ingredients button logic
            document.addEventListener('DOMContentLoaded', function() {
              // Always render the inventory table on page load
              fetch('/api/ingredients/inventory/all')
                .then(res => res.json())
                .then(data => {
                  // Debug output removed
                  const ingredients = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : (Array.isArray(data.ingredients) ? data.ingredients : []));
                  const container = document.getElementById('ingredients-inventory-table');
                  // Debug output removed
                  // Debug output removed
                  // Call function if possible
                  if (typeof window.renderIngredientsInventoryTable === 'function') {
                    if (container) container.innerHTML = '<div style="color:green;font-weight:bold;">[DEBUG] Calling renderIngredientsInventoryTable with ' + ingredients.length + ' ingredients.</div>';
                    // Debug output removed
                    window.renderIngredientsInventoryTable(ingredients);
                  } else {
                    if (container) container.innerHTML = '<div style="color:red;font-weight:bold;">Error: renderIngredientsInventoryTable is not defined.</div>';
                    console.error('renderIngredientsInventoryTable is not defined');
                  }
                })
                .catch(err => {
                  const container = document.getElementById('ingredients-inventory-table');
                  // Debug output removed
                  if (container) container.innerHTML = '<div style="color:red;font-weight:bold;">Error loading inventory data: ' + (err && err.message ? err.message : err) + '</div>';
                  console.error('Error loading inventory data:', err);
                });
            const loadExtractedBtn = document.getElementById('loadExtractedIngredientsBtn');
                if (loadExtractedBtn) {
              loadExtractedBtn.addEventListener('click', function() {
                const recipeId = document.getElementById('recipeSelectForText').value;
                console.log('[Show Recipe Ingredients] Clicked. Recipe ID:', recipeId);
                if (recipeId) {
                  setRecipeIdAndFilter(recipeId);
                } else {
                  console.warn('[Show Recipe Ingredients] No recipeId found');
                }
              });
            }
              function filterAndShowByRecipeId(forceShowAll = false) {
                const recipeId = document.getElementById('filter-recipe-id').value;
                console.log('[filterAndShowByRecipeId] Called. Recipe ID:', recipeId, 'forceShowAll:', forceShowAll);
                if (recipeId && !forceShowAll) {
                  fetch(`/api/ingredients/inventory/all`)
                    .then(res => res.json())
                    .then(data => {
                      const ingredients = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : (Array.isArray(data.ingredients) ? data.ingredients : []));
                      const filtered = ingredients.filter(row => String(row.recipe_id) === String(recipeId));
                      console.log('[filterAndShowByRecipeId] Filtered ingredients:', filtered);
                      window.renderIngredientsInventoryTable(filtered);
                    });
                } else if (typeof renderIngredientsInventory === 'function') {
                  console.log('[filterAndShowByRecipeId] Showing all ingredients');
                  renderIngredientsInventory();
                } else {
                  console.warn('[filterAndShowByRecipeId] renderIngredientsInventory is not a function');
                }
              }
              document.getElementById('show-ingredients-btn').onclick = function() { filterAndShowByRecipeId(); };
              document.getElementById('filter-ingredients-btn').onclick = function() {
                const recipeId = document.getElementById('filter-recipe-id').value;
                if (!recipeId) return;
                fetch(`/api/ingredients/inventory/all`)
                  .then(res => res.json())
                  .then(data => {
                    // Support both {data: [...]} and {ingredients: [...]} and raw array
                    const ingredients = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : (Array.isArray(data.ingredients) ? data.ingredients : []));
                    const filtered = ingredients.filter(row => String(row.recipe_id) === String(recipeId));
                    if (typeof renderIngredientsInventory === 'function') {
                      // Overwrite the table with only filtered rows
                      const container = document.getElementById('ingredients-inventory-table');
                      if (container) {
                        container.innerHTML = '';
                        // Reuse the table rendering logic from renderIngredientsInventory, but only for filtered
                        window.renderIngredientsInventoryTable(filtered);
                      }
                    } else if (typeof renderIngredientsTable === 'function') {
                      renderIngredientsTable(filtered);
                    }
                  });
              };
              // Helper to render the inventory table for a given array (for filter)
              window.renderIngredientsInventoryTable = function(ingredients) {
                const container = document.getElementById('ingredients-inventory-table');
                if (!container) return;
                // Use the same logic as in renderIngredientsInventory, but only for the given array
                fetch('food_brands.json').then(res => res.json()).then(brands => {
                  fetch('/api/aisle_keywords/all').then(res => res.json()).then(keywordsData => {
                    const keywords = keywordsData.keywords || [];
                    const categories = Array.from(new Set(keywords.map(k => k.aisle_category))).filter(Boolean).map((name, i) => ({ id: i + 1, name }));
                    function safe(val) { return val === null || val === undefined ? '' : val; }
                    function stripFoodItemDynamic(name) {
                      let stripped = name.replace(/\s*\([^)]*\)\s*$/, '').trim();
                      brands.forEach(brand => {
                        const re = new RegExp('^' + brand.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&") + "('?s)?\\s+", 'i');
                        stripped = stripped.replace(re, '');
                      });
                      // Handle patterns like 'number fooditem (abc)' and extract fooditem
                      // e.g. '16 marshmallows (best to use Explorer lollies)' -> 'marshmallows'
                      const match = stripped.match(/^(\d+)?\s*([a-zA-Z ]+)/);
                      if (match && match[2]) {
                        let item = match[2].trim();
                        // Special case for marshmallows
                        if (/marshmallow/i.test(item)) {
                          return 'marshmallows';
                        }
                        return item;
                      }
                      // Fallback: special case for marshmallows
                      if (/marshmallow/i.test(stripped)) {
                        return 'marshmallows';
                      }
                      return stripped.trim();
                    }
                    function findCategoryByKeyword(ingredient) {
                      const lower = (ingredient || '').toLowerCase();
                      const match = keywords.find(k => lower.includes((k.keyword || '').toLowerCase()));
                      return match ? match.aisle_category : '';
                    }
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.marginTop = '2rem';
                    table.style.borderCollapse = 'collapse';
                    // Debug: log categories and ingredients
                    console.log('[DEBUG] Categories:', categories);
                    console.log('[DEBUG] Ingredients:', ingredients);
                    // Build table HTML
                    table.innerHTML = `
                      <thead>
                        <tr style="background:#f5f5f5;">
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">ID</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">Ingredient Name</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">Recipe ID</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Quantity</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Measure Qty</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Measure Unit</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1FoodItem</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1StripFoodItem</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Aisle Category</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Assign</th>
                          <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${ingredients.length === 0 ? `<tr><td colspan='10' style='text-align:center;color:#888;padding:1rem;'>No ingredients in inventory.</td></tr>` :
                          ingredients.map(row => {
                            let stripFood = stripFoodItemDynamic(row.fooditem || '');
                            let assignedCategory = '';
                            if (row.aisle_category_id) {
                              const catObj = categories.find(c => c.id === row.aisle_category_id);
                              assignedCategory = catObj ? catObj.name : '';
                            } else {
                              assignedCategory = findCategoryByKeyword(row.fooditem || row.ingredient_name || '');
                            }
                            return `<tr>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.id)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.ingredient_name)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.recipe_id)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.quantity)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.measure_qty)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.measure_unit)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.fooditem) || safe(row.measure_unit)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem; color:green;">${stripFood || safe(row.measure_unit)}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${assignedCategory}</td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">
                                <select data-id="${row.id}" class="aisle-category-select">
                                  <option value="">--Assign--</option>
                                  ${categories.map(c => `<option value="${c.id}"${assignedCategory === c.name ? ' selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                              </td>
                              <td style="border:1px solid #eee;padding:0.5rem 0.7rem; text-align:center;">
                                <button class="delete-ingredient-btn" data-id="${row.id}" title="Delete this ingredient" style="color:#fff;background:#c00;border:none;padding:0.3rem 0.7rem;border-radius:3px;cursor:pointer;">Delete</button>
                              </td>
                            </tr>`;
                          }).join('')}
                      </tbody>
                    `;
                    // Debug: log generated table HTML
                    console.log('[DEBUG] Table HTML:', table.innerHTML);
                    container.innerHTML = '';
                    container.appendChild(table);
                    table.querySelectorAll('.aisle-category-select').forEach(select => {
                      select.onchange = function() {
                        const ingredientId = this.getAttribute('data-id');
                        const aisleId = this.value;
                        fetch(`/api/ingredients/inventory/assign-aisle`, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ ingredient_id: ingredientId, aisle_category_id: aisleId })
                        }).then(() => {
                          window.renderIngredientsInventoryTable(ingredients);
                        });
                      };
                    });
                    // Add DELETE button logic
                    table.querySelectorAll('.delete-ingredient-btn').forEach(btn => {
                      btn.onclick = function() {
                        const ingredientId = this.getAttribute('data-id');
                        if (!confirm('Are you sure you want to delete this ingredient?')) return;
                        fetch(`/api/ingredients/${ingredientId}`, {
                          method: 'DELETE'
                        })
                        .then(res => res.json())
                        .then(result => {
                          if (result.success) {
                            // Remove the row from the table in the UI
                            window.renderIngredientsInventoryTable(ingredients.filter(row => row.id != ingredientId));
                          } else {
                            alert('Failed to delete ingredient.');
                          }
                        })
                        .catch(() => alert('Failed to delete ingredient.'));
                      };
                    });
                  });
                });
              };
              document.getElementById('show-all-btn').onclick = function() {
                document.getElementById('filter-recipe-id').value = '';
                filterAndShowByRecipeId(true);
              };
              document.getElementById('clear-filter-btn').onclick = function() {
                document.getElementById('filter-recipe-id').value = '';
                if (typeof renderIngredientsTable === 'function') {
                  renderIngredientsTable([]);
                }
              };
              // Always auto-filter on page load
              filterAndShowByRecipeId();
            });
          </script>
    <script>
      // Save Extracted Ingredients button logic
      document.addEventListener('DOMContentLoaded', function() {
        const saveExtractedBtn = document.getElementById('saveExtractedIngredientsBtn');
        if (saveExtractedBtn) {
          saveExtractedBtn.addEventListener('click', function() {
            const recipeId = document.getElementById('recipeSelectForText').value;
            const textarea = document.getElementById('textConvertArea');
            if (!recipeId || !textarea.value.trim()) {
              alert('Select a recipe and enter ingredients.');
              return;
            }
            const ingredientsText = textarea.value.trim();
            fetch(`/api/ingredients/inventory/${recipeId}/extracted`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ingredients_text: ingredientsText })
            })
            .then(async res => {
              let data;
              try {
                data = await res.json();
              } catch (e) {
                alert('Failed to save extracted ingredients file: Invalid server response.');
                return;
              }
              if (res.ok && data && (data.success || data.file)) {
                alert('Extracted ingredients saved to ExtractedIngredients/' + recipeId + '.txt');
              } else if (data && (data.fileError || data.error)) {
                      // JavaScript logic moved to <script> tag at end of body. No JS code should be visible here.
              } else {
                alert('Failed to save extracted ingredients file: Unknown error (bad response)');
              }
            })
            .catch(err => {
              alert('Failed to save extracted ingredients file: ' + (err && err.message ? err.message : err));
            });
          });
        }
      });
    </script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingredients Directory</title>
  <link rel="stylesheet" href="../shared/style.css">
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>
  <div id="navbar-include"></div>
  <div class="ingredients-directory-card" style="margin:40px;">
    <h2>Ingredients Directory</h2>
    <p>This page will list all ingredients used in recipes, with search and filter options.</p>

    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;">
      <button id="deleteAllIngredientsBtn" style="background:#e53935;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;">DELETE ALL</button>
      <select id="recipeSelectForText" style="min-width:180px;"></select>
      <button id="insertIngredientsBtn" style="background:#6a1b9a;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;">Insert ingredients</button>
      <button id="splitQuantityBtn" style="background:#00897b;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;display:none;">Split Quantity</button>
      <span id="selectedRecipeIdLabel" style="font-weight:bold;color:#333;"></span>
      <span id="save-status" style="margin-left:1rem;color:#009688;font-weight:bold;"></span>
    </div>

    <!-- Move preview/textarea UI here -->
    <div style="margin-bottom:1.5rem;">
      <label for="textConvertArea" style="font-weight:bold;">Paste or enter ingredients here:</label><br>
      <textarea id="textConvertArea" rows="4" style="width:100%;max-width:600px;min-width:300px;display:block;margin-bottom:0.5rem;" placeholder="e.g. 2 cups flour\n1 tsp salt\n..."></textarea>
      <label for="ingredientsPreviewBox" style="font-weight:bold;">Recipe Ingredients Preview:</label><br>
      <textarea id="ingredientsPreviewBox" readonly style="width:100%;max-width:600px;min-width:300px;background:#f6f0ff;border:1px solid #e0d7fa;padding:0.5rem;display:block;"></textarea>
    </div>

    <!-- Table container for dynamic rendering -->
    <div id="ingredients-inventory-table" style="margin-top:2rem;"></div>

    <!-- Move all main scripts to end of body for reliability -->
    </div>
      <script>
      // --- MOVE TABLE RENDER FUNCTION DEFINITION TO TOP ---
      window.renderIngredientsInventoryTable = function(ingredients) {
        const container = document.getElementById('ingredients-inventory-table');
        if (!container) return;
        fetch('food_brands.json').then(res => res.json()).then(brands => {
          fetch('/api/aisle_keywords/all').then(res => res.json()).then(keywordsData => {
            const keywords = keywordsData.keywords || [];
            const categories = Array.from(new Set(keywords.map(k => k.aisle_category))).filter(Boolean).map((name, i) => ({ id: i + 1, name }));
            function safe(val) { return val === null || val === undefined ? '' : val; }
            function stripFoodItemDynamic(name) {
              let stripped = name.replace(/\s*\([^)]*\)\s*$/, '').trim();
              brands.forEach(brand => {
                const re = new RegExp('^' + brand.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&") + "('?s)?\\s+", 'i');
                stripped = stripped.replace(re, '');
              });
              const match = stripped.match(/^(\d+)?\s*([a-zA-Z ]+)/);
              if (match && match[2]) {
                let item = match[2].trim();
                if (/marshmallow/i.test(item)) {
                  return 'marshmallows';
                }
                return item;
              }
              if (/marshmallow/i.test(stripped)) {
                return 'marshmallows';
              }
              return stripped.trim();
            }
            function findCategoryByKeyword(ingredient) {
              const lower = (ingredient || '').toLowerCase();
              const match = keywords.find(k => lower.includes((k.keyword || '').toLowerCase()));
              return match ? match.aisle_category : '';
            }
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.marginTop = '2rem';
            table.style.borderCollapse = 'collapse';
            table.innerHTML = `
              <thead>
                <tr style="background:#f5f5f5;">
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">ID</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">Ingredient Name</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">Recipe ID</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Quantity</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Measure Qty</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Measure Unit</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1FoodItem</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1StripFoodItem</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Aisle Category</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Assign</th>
                  <th style="border:1px solid #eee;padding:0.5rem 0.7rem;">1Actions</th>
                </tr>
              </thead>
              <tbody>
                ${ingredients.length === 0 ? `<tr><td colspan='10' style='text-align:center;color:#888;padding:1rem;'>No ingredients in inventory.</td></tr>` :
                  ingredients.map(row => {
                    let stripFood = stripFoodItemDynamic(row.fooditem || '');
                    let assignedCategory = '';
                    if (row.aisle_category_id) {
                      const catObj = categories.find(c => c.id === row.aisle_category_id);
                      assignedCategory = catObj ? catObj.name : '';
                    } else {
                      assignedCategory = findCategoryByKeyword(row.fooditem || row.ingredient_name || '');
                    }
                    return `<tr>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.id)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.ingredient_name)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.recipe_id)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.quantity)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.measure_qty)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.measure_unit)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${safe(row.fooditem) || safe(row.measure_unit)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem; color:green;">${stripFood || safe(row.measure_unit)}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">${assignedCategory}</td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem;">
                        <select data-id="${row.id}" class="aisle-category-select">
                          <option value="">--Assign--</option>
                          ${categories.map(c => `<option value="${c.id}"${assignedCategory === c.name ? ' selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                      </td>
                      <td style="border:1px solid #eee;padding:0.5rem 0.7rem; text-align:center;">
                        <button class="delete-ingredient-btn" data-id="${row.id}" title="Delete this ingredient" style="color:#fff;background:#c00;border:none;padding:0.3rem 0.7rem;border-radius:3px;cursor:pointer;">Delete</button>
                      </td>
                    </tr>`;
                  }).join('')}
              </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);
            table.querySelectorAll('.aisle-category-select').forEach(select => {
              select.onchange = function() {
                const ingredientId = this.getAttribute('data-id');
                const aisleId = this.value;
                fetch(`/api/ingredients/inventory/assign-aisle`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ingredient_id: ingredientId, aisle_category_id: aisleId })
                }).then(() => {
                  window.renderIngredientsInventoryTable(ingredients);
                });
              };
            });
            table.querySelectorAll('.delete-ingredient-btn').forEach(btn => {
              btn.onclick = function() {
                const ingredientId = this.getAttribute('data-id');
                if (confirm('Delete this ingredient?')) {
                  fetch(`/api/ingredients/inventory/${ingredientId}`, { method: 'DELETE' })
                    .then(() => {
                      window.renderIngredientsInventoryTable(ingredients.filter(row => row.id != ingredientId));
                    });
                }
              };
            });
          });
        });
      };

      // --- END TABLE RENDER FUNCTION DEFINITION ---

      document.addEventListener('DOMContentLoaded', function() {
        // Convert Fragment button logic
        const convertFragmentBtn = document.getElementById('convertFragmentBtn');
        const textArea = document.getElementById('textConvertArea');
        if (convertFragmentBtn && textArea) {
          convertFragmentBtn.addEventListener('click', function() {
            const recipeId = document.getElementById('recipeSelectForText')?.value;
            let text = textArea.value.trim();
            console.log('[ConvertFragment] RecipeID:', recipeId);
            console.log('[ConvertFragment] Raw text:', text);
            // Remove any 'recipeIngredient' label and extract the array if present
            let arrayMatch = text.match(/"recipeIngredient"\s*:\s*(\[.*?\])/s);
            if (arrayMatch) {
              console.log('[ConvertFragment] Found recipeIngredient array:', arrayMatch[1]);
              text = arrayMatch[1];
            }
            // Remove any object wrapper (e.g. { ... })
            if (text.startsWith('{') && text.endsWith('}')) {
              try {
                let obj = JSON.parse(text);
                if (obj.recipeIngredient && Array.isArray(obj.recipeIngredient)) {
                  console.log('[ConvertFragment] Parsed object.recipeIngredient:', obj.recipeIngredient);
                  text = obj.recipeIngredient.join('\n');
                }
              } catch (e) {
                console.warn('[ConvertFragment] JSON.parse failed for object wrapper:', e);
                // fallback: remove outer braces
                text = text.replace(/^\{/, '').replace(/\}$/,'');
              }
            }
            // If text is a JSON array, flatten it
            if (text.startsWith('[') && text.endsWith(']')) {
              try {
                const arr = JSON.parse(text);
                if (Array.isArray(arr)) {
                  console.log('[ConvertFragment] Parsed JSON array:', arr);
                  text = arr.join('\n');
                }
              } catch (e) {
                console.warn('[ConvertFragment] JSON.parse failed for array:', e);
              }
            }
            // Remove any remaining brackets, braces, or quotes, and flatten to lines
            text = text.replace(/^[\[\]\{\}"]+/g, '').replace(/[\[\]\{\}"]+$/g, '');
            let lines = text.split(/\r?\n|,/).map(l => l.replace(/^"|"$/g, '').trim()).filter(Boolean);
            console.log('[ConvertFragment] Lines after split:', lines);
            // Helper to convert unicode and vulgar fractions to float
            function parseFraction(str) {
              const vulgarMap = {
                '¼': 0.25, '½': 0.5, '¾': 0.75,
                '⅐': 1/7, '⅑': 1/9, '⅒': 0.1, '⅓': 1/3, '⅔': 2/3, '⅕': 0.2, '⅖': 0.4, '⅗': 0.6, '⅘': 0.8, '⅙': 1/6, '⅚': 5/6, '⅛': 0.125, '⅜': 0.375, '⅝': 0.625, '⅞': 0.875
              };
              str = str.trim();
              // Replace vulgar fractions
              str = str.replace(/[¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞]/g, m => ' ' + vulgarMap[m]);
              // Handle mixed numbers (e.g., 1 1/2)
              let parts = str.split(' ');
              let total = 0;
              for (let part of parts) {
                if (/^\d+$/.test(part)) total += parseInt(part);
                else if (/^\d+\/\d+$/.test(part)) {
                  let [n, d] = part.split('/');
                  total += parseInt(n) / parseInt(d);
                } else if (!isNaN(parseFloat(part))) {
                  total += parseFloat(part);
                }
              }
              return total || null;
            }
            // Accept common units
            const units = [
              'cup', 'cups', 'tbsp', 'tablespoon', 'tablespoons', 'tsp', 'teaspoon', 'teaspoons',
              'g', 'gram', 'grams', 'kg', 'kilogram', 'kilograms', 'ml', 'l', 'litre', 'litres', 'liter', 'liters',
              'oz', 'ounce', 'ounces', 'lb', 'pound', 'pounds', 'pinch', 'dash', 'clove', 'cloves', 'can', 'cans', 'slice', 'slices', 'stick', 'sticks', 'packet', 'packets', 'piece', 'pieces', 'egg', 'eggs', 'drop', 'drops', 'block', 'blocks', 'sheet', 'sheets', 'bunch', 'bunches', 'sprig', 'sprigs', 'head', 'heads', 'filet', 'filets', 'fillet', 'fillets', 'bag', 'bags', 'jar', 'jars', 'bottle', 'bottles', 'container', 'containers', 'box', 'boxes', 'bar', 'bars', 'roll', 'rolls', 'strip', 'strips', 'cm', 'mm', 'inch', 'inches', 'pinches', 'handful', 'handfuls', 'dozen', 'sheet', 'sheets', 'leaf', 'leaves', 'stalk', 'stalks', 'rib', 'ribs', 'segment', 'segments', 'piece', 'pieces', 'cube', 'cubes', 'drop', 'drops', 'sprinkle', 'sprinkles', 'dash', 'dashes', 'splash', 'splashes', 'liter', 'liters', 'milliliter', 'milliliters', 'millilitre', 'millilitres', 'quart', 'quarts', 'pint', 'pints', 'gallon', 'gallons', 'ml', 'l', 'dl', 'cl', 'mg', 'mcg', 'µg', 'kg', 'g', 'lb', 'oz', 'cup', 'cups', 'tbsp', 'tsp', 'teaspoon', 'tablespoon', 'pinch', 'dash', 'drop', 'handful', 'stick', 'slice', 'piece', 'clove', 'can', 'bunch', 'sprig', 'head', 'filet', 'fillet', 'block', 'sheet', 'bag', 'jar', 'bottle', 'container', 'box', 'bar', 'roll', 'strip', 'cm', 'mm', 'inch', 'pinches', 'handfuls', 'dozen', 'leaves', 'stalks', 'ribs', 'segments', 'cubes', 'sprinkles', 'splashes', 'litre', 'litres', 'millilitre', 'millilitres', 'quart', 'quarts', 'pint', 'pints', 'gallon', 'gallons'
            ];
            const unitPattern = units.join('|');
            const regex = new RegExp(`^([\d\s\/\.¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞]+)\s*(${unitPattern})\b\s*(.+)$`, 'i');
            // Convert fractions in each line to decimals if possible
            lines = lines.map(line => {
              // Only match and replace a leading quantity (fraction/mixed/decimal) at the start
              const qtyRegex = /^([\d\s\/\.¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞]+)(?=\s*([a-zA-Z]+)\b)/;
              const match = line.match(qtyRegex);
              if (match) {
                const qty = parseFraction(match[1]);
                if (qty !== null) {
                  // Replace only the matched quantity at the start
                  return line.replace(qtyRegex, qty);
                }
              }
              return line;
            });
            console.log('[ConvertFragment] Lines after quantity conversion:', lines);
            text = lines.join('\n');
            textArea.value = text;
          });
        }

        // Split Quantity button logic
        const splitBtn = document.getElementById('splitQuantityBtn');
        if (splitBtn) {
          splitBtn.addEventListener('click', function() {
            const recipeId = document.getElementById('recipeSelectForText').value;
            if (!recipeId) {
              alert('Select a recipe first.');
              return;
            }
            fetch('/api/ingredients/inventory/split-quantity', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: recipeId, splitQty: 1 })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                document.getElementById('save-status').innerHTML = '<span style="color:#009688;">Quantities and food items split and updated!</span>';
                document.dispatchEvent(new Event('ingredients-inventory-refresh'));
              } else {
                document.getElementById('save-status').innerHTML = '<span style="color:#e53935;">Failed to split quantities: ' + (data.error || 'Unknown error') + '</span>';
              }
            })
            .catch(() => {
              document.getElementById('save-status').innerHTML = '<span style="color:#e53935;">Error contacting server.</span>';
            });
          });
        }
      });
      </script>
    <br/>
    <label for="textConvertArea" style="font-weight:bold;">Paste or enter ingredients here:</label>
    <textarea id="textConvertArea" rows="4" style="width:100%;max-width:600px;margin:1rem 0;display:block;" placeholder="e.g. 2 cups flour\n1 tsp salt\n..."></textarea>
    <div style="margin-bottom:1rem;"></div>
    <div id="insert-ingredients-preview-container" style="display:none;margin-bottom:1.5rem;">
      <label style="font-weight:bold;">Preview: Extracted Ingredients File</label>
      <pre id="insert-ingredients-preview" style="background:#f3eaff;border:1px solid #b39ddb;padding:1rem;border-radius:4px;max-width:600px;overflow-x:auto;"></pre>
    </div>
      <label for="ingredientsPreviewBox" style="font-weight:bold;">Recipe Ingredients Preview:</label>
      <pre id="ingredientsPreviewBox" style="width:100%;max-width:600px;margin:1rem 0;display:block;background:#f3eaff;border:1px solid #b39ddb;padding:1rem;border-radius:4px;overflow-x:auto;min-height:60px;"></pre>
      <script>
        // Synchronize preview box with textarea live
        document.addEventListener('DOMContentLoaded', function() {
          const textArea = document.getElementById('textConvertArea');
          const previewBox = document.getElementById('ingredientsPreviewBox');
          if (textArea && previewBox) {
            // Initial sync
            previewBox.textContent = textArea.value;
            // On input
            textArea.addEventListener('input', function() {
              previewBox.textContent = textArea.value;
            });
          }
        });
      </script>
        <script>
          // Insert Ingredients button logic
          document.addEventListener('DOMContentLoaded', function() {
            const insertBtn = document.getElementById('insertIngredientsBtn');
            const previewContainer = document.getElementById('insert-ingredients-preview-container');
            const previewBox = document.getElementById('insert-ingredients-preview');
            const saveStatus = document.getElementById('save-status');
            if (insertBtn && previewContainer && previewBox) {
              insertBtn.addEventListener('click', function() {
                const recipeId = document.getElementById('recipeSelectForText').value;
                if (!recipeId) {
                  alert('Select a recipe first.');
                  return;
                }
                // Use the preview box value (ingredients_display) for insertion
                console.log('[InsertIngredients] Button clicked for RecipeID:', recipeId);
                let text = document.getElementById('ingredientsPreviewBox').textContent;
                console.log('[InsertIngredients] Text from preview box:', text);
                // Convert <br>, <br/>, <br /> to newlines (shouldn't be needed, but for safety)
                text = text.replace(/<br\s*\/?>/gi, '\n');
                console.log('[InsertIngredients] Text after <br> to newline:', text);
                // Split lines and filter out empty lines and star ratings
                let lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                console.log('[InsertIngredients] Lines after split:', lines);
                // Remove lines that are just star ratings (e.g. '5 Star', '4 Star', etc.)
                lines = lines.filter(line => !/^([1-5]\s*Star)$/i.test(line));
                console.log('[InsertIngredients] Lines after filtering star ratings:', lines);
                if (lines.length === 0) {
                  saveStatus.innerHTML = '<span style="color:#e53935;">No ingredients found in preview.</span>';
                  return;
                }
                // Use parseIngredient from ingredients_parse.js for each line
                if (typeof parseIngredient !== 'function') {
                  alert('Ingredient parser not loaded.');
                  return;
                }
                const parsedIngredients = lines.map(line => {
                  const parsed = parseIngredient(line);
                  console.log('[InsertIngredients] Parsed ingredient:', parsed, 'from line:', line);
                  return {
                    ingredient_name: parsed.name || line,
                    quantity: parsed.quantity || '',
                    measure_qty: parsed.quantity || '',
                    measure_unit: parsed.unit || '',
                    fooditem: parsed.name || line,
                    stripFoodItem: (typeof stripFoodItem === 'function') ? stripFoodItem(parsed.name || line) : '',
                    aisle_category_id: null,
                    recipe_id: recipeId
                  };
                });
                console.log('[InsertIngredients] Parsed ingredients array:', parsedIngredients);
                fetch('/api/ingredients/inventory/save-bulk', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ingredients: parsedIngredients })
                })
                .then(res => res.json())
                .then(data => {
                  console.log('[InsertIngredients] save-bulk response:', data);
                  if (data.success) {
                    // Now trigger split-quantity for this recipe
                    fetch('/api/ingredients/inventory/split-quantity', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ id: recipeId, splitQty: 1 })
                    })
                    .then(res2 => res2.json())
                    .then(data2 => {
                      console.log('[InsertIngredients] split-quantity response:', data2);
                      if (data2.success) {
                        // Now trigger auto-assign aisles
                        fetch('/api/ingredients/inventory/auto-assign-aisles', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ recipe_id: recipeId })
                        })
                        .then(res3 => res3.json())
                        .then(data3 => {
                          console.log('[InsertIngredients] auto-assign-aisles response:', data3);
                          if (data3.success) {
                            saveStatus.innerHTML = '<span style="color:#009688;">Ingredients inserted, split, and aisles assigned!</span>';
                          } else {
                            saveStatus.innerHTML = '<span style="color:#e53935;">Ingredients inserted and split, but failed to assign aisles.</span>';
                          }
                          document.dispatchEvent(new Event('ingredients-inventory-refresh'));
                        })
                        .catch((err) => {
                          console.error('[InsertIngredients] auto-assign-aisles error:', err);
                          saveStatus.innerHTML = '<span style="color:#e53935;">Error assigning aisles after split.</span>';
                          document.dispatchEvent(new Event('ingredients-inventory-refresh'));
                        });
                      } else {
                        saveStatus.innerHTML = '<span style="color:#e53935;">Ingredients inserted, but failed to split quantities.</span>';
                        document.dispatchEvent(new Event('ingredients-inventory-refresh'));
                      }
                    })
                    .catch((err) => {
                      console.error('[InsertIngredients] split-quantity error:', err);
                      saveStatus.innerHTML = '<span style="color:#e53935;">Error splitting quantities after insert.</span>';
                      document.dispatchEvent(new Event('ingredients-inventory-refresh'));
                    });
                  } else {
                    saveStatus.innerHTML = '<span style="color:#e53935;">Failed to insert ingredients from preview.</span>';
                  }
                })
                .catch((err) => {
                  console.error('[InsertIngredients] save-bulk error:', err);
                  saveStatus.innerHTML = '<span style="color:#e53935;">Error contacting server.</span>';
                });
              });
            }
          });
        </script>
    <div id="reformat-status" style="margin-bottom:1.5rem;"></div>
    <!-- Duplicate removed: ingredients-inventory-table -->
      <div id="ingredients-inventory-debug-table"></div>
    <h3 style="margin-top:3rem;">All Recipes</h3>
    <div id="recipes-table-container"></div>
    <script>
      // Always render ingredients table on page load
      document.addEventListener('DOMContentLoaded', function() {
        if (window.renderIngredientsInventory) renderIngredientsInventory();
      });
      // Also refresh after inventory actions
      document.addEventListener('ingredients-inventory-refresh', function() {
        if (window.renderIngredientsInventory) renderIngredientsInventory();
      });

      // Save Ingredients to Recipe button logic
      var saveIngredientsBtn = document.getElementById('saveIngredientsBtn');
      if (saveIngredientsBtn) saveIngredientsBtn.addEventListener('click', function() {
        const recipeId = document.getElementById('recipeSelectForText').value;
        const textarea = document.getElementById('textConvertArea');
        const saveStatus = document.getElementById('save-status');
        function showStatus(msg, color) {
          saveStatus.innerHTML = `<span style="color:${color};cursor:pointer;" id="save-status-close">${msg} (click to dismiss)</span>`;
          document.getElementById('save-status-close').onclick = () => { saveStatus.textContent = ''; };
        }
        if (!recipeId || !textarea.value.trim()) {
          showStatus('Select a recipe and enter ingredients.', '#e53935');
          return;
        }
        let ingredientsText = textarea.value.trim();
        // Also save to ExtractedIngredients/{recipeId}.txt
        fetch(`/api/ingredients/inventory/${recipeId}/extracted`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ingredients_text: ingredientsText })
        })
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            console.error('Failed to save extracted ingredients file:', data.fileError || 'Unknown error');
          }
        })
        .catch(err => {
          console.error('Failed to save extracted ingredients file:', err);
        });
        fetch('/api/ingredients/save-bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipe_id: recipeId, ingredients: ingredientsText })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // After saving, immediately sync inventory
            fetch('/api/ingredients-inventory/sync', { method: 'POST' })
              .then(res2 => res2.json())
              .then(data2 => {
                showStatus('Ingredients saved and inventory synced!', '#009688');
                document.dispatchEvent(new Event('ingredients-inventory-refresh'));
              })
              .catch(() => {
                showStatus('Ingredients saved, but inventory sync failed.', '#e53935');
              });
          } else {
            showStatus('Save failed.', '#e53935');
          }
        })
        .catch(() => {
          showStatus('Save failed.', '#e53935');
        });
      });

      // Inline editing for ingredients table (basic demo)
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          const table = document.querySelector('#ingredients-inventory-table table');
          if (!table) return;
          table.querySelectorAll('td').forEach(td => {
            td.addEventListener('dblclick', function() {
              const oldValue = td.textContent;
              const input = document.createElement('input');
              input.value = oldValue;
              input.style.width = '90%';
              td.textContent = '';
              td.appendChild(input);
              input.focus();
              input.addEventListener('blur', function() {
                td.textContent = input.value;
                // TODO: send update to backend if needed
              });
              input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') input.blur();
              });
            });
          });
        }, 500);
      });
    </script>
  </div>
  <script>
    // Dynamically load the shared navbar
    fetch('_navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbar-include').innerHTML = html;
      });
  </script>
  <script src="ingredients_inventory_table.js"></script>
  <script src="ingredients_parse.js"></script>
  <script src="text_conversion.js"></script>
  <script src="split_measure_button.js"></script>
  <script>
    // Populate recipe dropdown
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/api/recipes')
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('recipeSelectForText');
          if (select) {
            select.innerHTML = '<option value="">-- Select Recipe --</option>' +
              data.map(r => `<option value="${r.id}">${r.id} | ${r.name || r.recipe_title || 'Recipe ' + r.id}</option>`).join('');
          }
        });
      const select = document.getElementById('recipeSelectForText');
      const recipeIdLabel = document.getElementById('selectedRecipeIdLabel');
      if (select) {
        select.addEventListener('change', function() {
          const recipeId = select.value;
          if (recipeIdLabel) recipeIdLabel.textContent = recipeId ? `Recipe ID: ${recipeId}` : '';
          if (!recipeId) return;
          fetch(`/api/recipes/${recipeId}`)
            .then(res => res.json())
            .then(recipe => {
              // Use ONLY ingredients_display from the recipe table
              let text = '';
              if (typeof recipe.ingredients_display === 'string' && recipe.ingredients_display.trim()) {
                text = recipe.ingredients_display;
              } else {
                text = '';
              }
              // Split on <br>, <br/>, <br /> to get each ingredient on its own line
              let cleanedText = text
                .replace(/<br\s*\/?>(?=\s|$)/gi, '\n')
                .split(/\r?\n/)
                .map(l => l.trim())
                .filter(l => l && !/^([1-5]\s*Star)$/i.test(l))
                .join('\n');
              document.getElementById('textConvertArea').value = cleanedText;
              // Also update preview box
              const previewBox = document.getElementById('ingredientsPreviewBox');
              if (previewBox) previewBox.textContent = cleanedText;
              // Automatically trigger Convert Fragment logic
              const convertFragmentBtn = document.getElementById('convertFragmentBtn');
              const textArea = document.getElementById('textConvertArea');
              if (convertFragmentBtn && textArea) {
                convertFragmentBtn.click();
              }
            });
        });
      }
    });
  </script>
  <script>
    function syncInventory(auto) {
      // If auto, do not show confirm or alert
      if (!auto) {
        if (!confirm('This will overwrite the inventory with all ingredients from all recipes. Continue?')) return;
      }
      fetch('/api/ingredients-inventory/sync', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.dispatchEvent(new Event('ingredients-inventory-refresh'));
            if (!auto) alert('Inventory synced from all recipes.');
          } else {
            if (!auto) alert('Failed to sync inventory.');
          }
        })
        .catch(() => { if (!auto) alert('Error contacting server.'); });
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      <!-- All main scripts moved to end of body for reliability -->
      const convertFragmentBtn = document.getElementById('convertFragmentBtn');
      const textArea = document.getElementById('textConvertArea');
      if (convertFragmentBtn && textArea) {
        convertFragmentBtn.addEventListener('click', function() {
              let text = textArea.value.trim();
              // Remove any 'recipeIngredient' label and extract the array if present
              let arrayMatch = text.match(/"recipeIngredient"\s*:\s*(\[.*?\])/s);
              if (arrayMatch) {
                text = arrayMatch[1];
              }
              // Remove any object wrapper (e.g. { ... })
              if (text.startsWith('{') && text.endsWith('}')) {
                try {
                  let obj = JSON.parse(text);
                  if (obj.recipeIngredient && Array.isArray(obj.recipeIngredient)) {
                    text = obj.recipeIngredient.join('\n');
                  }
                } catch (e) {
                  // fallback: remove outer braces
                  text = text.replace(/^\{/, '').replace(/\}$/, '');
                }
              }
              // If text is a JSON array, flatten it
              if (text.startsWith('[') && text.endsWith(']')) {
                try {
                  const arr = JSON.parse(text);
                  if (Array.isArray(arr)) {
                    text = arr.join('\n');
                  }
                } catch (e) {}
              }
              // Remove any remaining brackets, braces, or quotes, and flatten to lines
              text = text.replace(/^[\[\]\{\}"]+/g, '').replace(/[\[\]\{\}"]+$/g, '');
              let lines = text.split(/\r?\n|,/).map(l => l.replace(/^"|"$/g, '').trim()).filter(Boolean);

              // Helper to convert unicode and vulgar fractions to float
              function parseFraction(str) {
                const vulgarMap = {
                  '¼': 0.25, '½': 0.5, '¾': 0.75,
                  '⅐': 1/7, '⅑': 1/9, '⅒': 0.1, '⅓': 1/3, '⅔': 2/3, '⅕': 0.2, '⅖': 0.4, '⅗': 0.6, '⅘': 0.8, '⅙': 1/6, '⅚': 5/6, '⅛': 0.125, '⅜': 0.375, '⅝': 0.625, '⅞': 0.875
                };
                str = str.trim();
                // Replace vulgar fractions
                str = str.replace(/[¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞]/g, m => ' ' + vulgarMap[m]);
                // Handle mixed numbers (e.g., 1 1/2)
                let parts = str.split(' ');
                let total = 0;
                for (let part of parts) {
                  if (/^\d+$/.test(part)) total += parseInt(part);
                  else if (/^\d+\/\d+$/.test(part)) {
                    let [n, d] = part.split('/');
                    total += parseInt(n) / parseInt(d);
                  } else if (!isNaN(parseFloat(part))) {
                    total += parseFloat(part);
                  }
                }
                return total || null;
              }

              // Accept common units
              const units = [
                'cup', 'cups', 'tbsp', 'tablespoon', 'tablespoons', 'tsp', 'teaspoon', 'teaspoons',
                'g', 'gram', 'grams', 'kg', 'kilogram', 'kilograms', 'ml', 'l', 'litre', 'litres', 'liter', 'liters',
                'oz', 'ounce', 'ounces', 'lb', 'pound', 'pounds', 'pinch', 'dash', 'clove', 'cloves', 'can', 'cans', 'slice', 'slices', 'stick', 'sticks', 'packet', 'packets', 'piece', 'pieces', 'egg', 'eggs', 'drop', 'drops', 'block', 'blocks', 'sheet', 'sheets', 'bunch', 'bunches', 'sprig', 'sprigs', 'head', 'heads', 'filet', 'filets', 'fillet', 'fillets', 'bag', 'bags', 'jar', 'jars', 'bottle', 'bottles', 'container', 'containers', 'box', 'boxes', 'bar', 'bars', 'roll', 'rolls', 'strip', 'strips', 'cm', 'mm', 'inch', 'inches', 'pinches', 'handful', 'handfuls', 'dozen', 'sheet', 'sheets', 'leaf', 'leaves', 'stalk', 'stalks', 'rib', 'ribs', 'segment', 'segments', 'piece', 'pieces', 'cube', 'cubes', 'drop', 'drops', 'sprinkle', 'sprinkles', 'dash', 'dashes', 'splash', 'splashes', 'liter', 'liters', 'milliliter', 'milliliters', 'millilitre', 'millilitres', 'quart', 'quarts', 'pint', 'pints', 'gallon', 'gallons', 'ml', 'l', 'dl', 'cl', 'mg', 'mcg', 'µg', 'kg', 'g', 'lb', 'oz', 'cup', 'cups', 'tbsp', 'tsp', 'teaspoon', 'tablespoon', 'pinch', 'dash', 'drop', 'handful', 'stick', 'slice', 'piece', 'clove', 'can', 'bunch', 'sprig', 'head', 'filet', 'fillet', 'block', 'sheet', 'bag', 'jar', 'bottle', 'container', 'box', 'bar', 'roll', 'strip', 'cm', 'mm', 'inch', 'pinches', 'handfuls', 'dozen', 'leaves', 'stalks', 'ribs', 'segments', 'cubes', 'sprinkles', 'splashes', 'litre', 'litres', 'millilitre', 'millilitres', 'quart', 'quarts', 'pint', 'pints', 'gallon', 'gallons'
              ];
              const unitPattern = units.join('|');
              const regex = new RegExp(`^([\d\s\/\.¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞]+)\s*(${unitPattern})\b\s*(.+)$`, 'i');

              // Convert fractions in each line to decimals if possible
              lines = lines.map(line => {
                // Only match and replace a leading quantity (fraction/mixed/decimal) at the start
                const qtyRegex = /^([\d\s\/\.¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞]+)(?=\s*([a-zA-Z]+)\b)/;
                const match = line.match(qtyRegex);
                if (match) {
                  const qty = parseFraction(match[1]);
                  if (qty !== null) {
                    // Replace only the matched quantity at the start
                    return line.replace(qtyRegex, qty);
                  }
                }
                return line;
              });
              text = lines.join('\n');
              textArea.value = text;

              // After conversion, trigger split-quantity for the selected recipe only
              const recipeId = document.getElementById('recipeSelectForText').value;
              if (recipeId) {
                fetch('/api/ingredients/inventory/split-quantity', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ recipe_id: recipeId })
                })
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    document.getElementById('reformat-status').innerHTML = '<span style="color:green;">Quantities and food items split for this recipe!</span>';
                  }
                  fetch('/api/ingredients/inventory/save-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients: lines.map(line => ({ ingredient_name: line, recipe_id: recipeId })) })
                  })
                  .catch(() => {
                    document.getElementById('reformat-status').innerHTML = '<span style="color:red;">Error contacting server.</span>';
                  });
                })
                .catch(() => {
                  document.getElementById('reformat-status').innerHTML = '<span style="color:red;">Error contacting server.</span>';
                });
              }
            });
          }
    });
  </script>
  <script>
    //DELETE ALL: Remove from both inventory and main ingredients table, then refresh
    document.getElementById('deleteAllIngredientsBtn').addEventListener('click', function() {
      if (confirm('Are you sure you want to delete ALL ingredients?')) {
        fetch('/api/ingredients-inventory', { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            fetch('/api/ingredients', { method: 'DELETE' })
              .then(res2 => res2.json())
              .then(data2 => {
                alert('All ingredients deleted.');
                document.dispatchEvent(new Event('ingredients-inventory-refresh'));
              });
          });
      }
    });
  </script>
</body>
</html>